# NGINX Ingress with canary annotations
# This approach uses NGINX Ingress Controller's native canary support

# Main production ingress
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: crm-app-production
  labels:
    app: crm-app
  annotations:
    kubernetes.io/ingress.class: "nginx"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
spec:
  tls:
  - hosts:
    - crm.example.com
    secretName: crm-app-tls
  rules:
  - host: crm.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: crm-app-stable
            port:
              number: 80
---
# Canary ingress - receives percentage of traffic
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: crm-app-canary
  labels:
    app: crm-app
    track: canary
  annotations:
    kubernetes.io/ingress.class: "nginx"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    # Canary annotations
    nginx.ingress.kubernetes.io/canary: "true"
    nginx.ingress.kubernetes.io/canary-weight: "10"  # 10% of traffic
    # Optional: Route based on header
    # nginx.ingress.kubernetes.io/canary-by-header: "X-Canary"
    # nginx.ingress.kubernetes.io/canary-by-header-value: "always"
spec:
  tls:
  - hosts:
    - crm.example.com
    secretName: crm-app-tls
  rules:
  - host: crm.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: crm-app-canary
            port:
              number: 80
---
# Direct canary testing ingress
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: crm-app-canary-direct
  labels:
    app: crm-app
    track: canary
  annotations:
    kubernetes.io/ingress.class: "nginx"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
spec:
  tls:
  - hosts:
    - canary.crm.example.com
    secretName: crm-app-canary-tls
  rules:
  - host: canary.crm.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: crm-app-canary
            port:
              number: 80
