version: '3.8'

# Advanced Docker Compose with:
# - BuildKit cache optimization
# - Multi-app orchestration
# - Health checks
# - Resource limits
# - Logging configuration

x-common-build: &common-build
  cache_from:
    - type=registry,ref=ghcr.io/dummycomp/cache:latest
  args:
    BUILDKIT_INLINE_CACHE: "1"

x-common-logging: &common-logging
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"

services:
  crm-app:
    build:
      context: ./crm-app
      dockerfile: Dockerfile
      <<: *common-build
      target: runner
    image: dummycomp/crm-app:latest
    container_name: crm-app
    ports:
      - "3000:3000"
    environment:
      # Supabase Configuration
      - NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL:-https://dummy.supabase.co}
      - NEXT_PUBLIC_SUPABASE_ANON_KEY=${NEXT_PUBLIC_SUPABASE_ANON_KEY:-eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.dummy}

      # Webhook Configuration
      - N8N_WEBHOOK_URL=${N8N_WEBHOOK_URL:-https://demo-n8n.example.com/webhook/demo}
      - N8N_API_KEY=${N8N_API_KEY:-demo_api_key}
      - WEBHOOK_SECRET=${WEBHOOK_SECRET:-demo_webhook_secret}

      # Application Configuration
      - NODE_ENV=production
      - NEXT_TELEMETRY_DISABLED=1

      # AI Configuration
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/api/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging: *common-logging
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    networks:
      - dummycomp-network
    labels:
      - "com.dummycomp.service=crm-app"
      - "com.dummycomp.version=1.0.0"

  website:
    build:
      context: ./website
      dockerfile: Dockerfile
      <<: *common-build
      target: runner
    image: dummycomp/website:latest
    container_name: website
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
      - NEXT_TELEMETRY_DISABLED=1
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3001/', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging: *common-logging
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    networks:
      - dummycomp-network
    labels:
      - "com.dummycomp.service=website"
      - "com.dummycomp.version=1.0.0"

  # Nginx reverse proxy (optional)
  nginx:
    image: nginx:alpine
    container_name: nginx-proxy
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/certs:/etc/nginx/certs:ro
    depends_on:
      - crm-app
      - website
    restart: unless-stopped
    logging: *common-logging
    networks:
      - dummycomp-network
    profiles:
      - with-proxy
    labels:
      - "com.dummycomp.service=nginx-proxy"

networks:
  dummycomp-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  cache-data:
    driver: local
