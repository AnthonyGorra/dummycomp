;; PgBouncer Configuration for CRM Application
;; ============================================================================
;; Connection Pooling Configuration
;; ============================================================================

[databases]
; Database connection strings
; Format: dbname = host=hostname port=port dbname=database auth_user=username

; Primary database connection (Supabase)
; Replace with your actual Supabase connection details
crm_db = host=${DB_HOST} port=5432 dbname=${DB_NAME} auth_user=${DB_USER}

; Read replica connection (if configured)
crm_db_replica = host=${DB_REPLICA_HOST} port=5432 dbname=${DB_NAME} auth_user=${DB_USER}

[pgbouncer]
;;;
;;; Administrative settings
;;;

logfile = /var/log/pgbouncer/pgbouncer.log
pidfile = /var/run/pgbouncer/pgbouncer.pid

;;;
;;; Where to wait for clients
;;;

; IP address or * which means all IPs
listen_addr = 0.0.0.0
listen_port = 6432

; Unix socket is also used for local connections
unix_socket_dir = /var/run/postgresql
unix_socket_mode = 0777
unix_socket_group =

;;;
;;; TLS settings for client and server connections
;;;

; Enable TLS for client connections (recommended for production)
client_tls_sslmode = prefer
client_tls_ca_file = /etc/ssl/certs/ca-certificates.crt
client_tls_cert_file =
client_tls_key_file =

; TLS settings for server connections (to PostgreSQL/Supabase)
server_tls_sslmode = require

;;;
;;; Authentication settings
;;;

; Authentication type for clients
; Use 'md5', 'scram-sha-256', or 'cert' based on your setup
auth_type = md5
auth_file = /etc/pgbouncer/userlist.txt

; Query to load user passwords (for dynamic password lookup)
; Requires auth_type = hba or auth_type = scram-sha-256
; auth_query = SELECT usename, passwd FROM pg_shadow WHERE usename=$1

;;;
;;; Users allowed into database
;;;

; Allow all users
admin_users = postgres, ${DB_ADMIN_USER}
stats_users = ${DB_STATS_USER}

;;;
;;; Pooler personality questions
;;;

; Connection pool mode
; - session: One server connection per client connection (default)
; - transaction: Server connection is assigned to client only during a transaction
; - statement: Server connection is assigned to client for each statement
;
; RECOMMENDED: transaction mode for web applications
; Use session mode only if you need:
; - Temporary tables
; - SET/RESET of session variables
; - PREPARE statements
pool_mode = transaction

; Maximum number of server connections per database+user combination
; This is the TOTAL number of connections to PostgreSQL
; For Supabase, check your plan limits (Free: 60, Pro: 200+)
max_db_connections = 100

; Default pool size (per database+user)
; Number of server connections to allow per user+database pair
default_pool_size = 25

; Minimum number of server connections to keep open
min_pool_size = 10

; Reserve pool size - how many additional connections to allow in emergency
reserve_pool_size = 10

; Maximum number of client connections allowed
; This should be higher than max_db_connections to allow pooling
max_client_conn = 500

; Maximum number of additional connections to a pool that can be used
; before waiting for an available connection
max_user_connections = 100

;;;
;;; Connection limits and timeouts
;;;

; Server connection timeout (seconds)
; If a server connection cannot be made in this time, it is considered failed
server_connect_timeout = 15

; Server login retry interval (seconds)
server_login_retry = 15

; Query timeout (seconds)
; If a query takes longer than this, connection is closed
; Set to 0 to disable (recommended for web apps with their own timeouts)
query_timeout = 0

; Query wait timeout (seconds)
; If client has been waiting for a connection longer than this, it's disconnected
; Recommended: 30-120 seconds for web applications
query_wait_timeout = 120

; Client idle timeout (seconds)
; If client has been idle more than this, it's disconnected
; In transaction mode, this is applied when transaction is over
; Recommended: 600 seconds (10 minutes) for web apps
client_idle_timeout = 600

; Server idle timeout (seconds)
; If server connection has been idle more than this, it's closed
; Recommended: 600 seconds (10 minutes)
server_idle_timeout = 600

; Connection lifetime (seconds)
; Connection is closed after being open this long
; Recommended: 3600 (1 hour) to periodically refresh connections
server_lifetime = 3600

; Disconnect server after idle time (seconds) when pool is full
server_idle_timeout = 600

;;;
;;; Dangerous timeouts
;;;

; Close server connection if it has been connected but not used for this long
server_check_delay = 30

; How long to wait for DNS queries
dns_max_ttl = 15
dns_zone_check_period = 0

; DNS caching
dns_nxdomain_ttl = 15

;;;
;;; TLS settings
;;;

server_reset_query = DISCARD ALL
server_reset_query_always = 0

;;;
;;; Logging
;;;

; Log verbosity
; 0 = quiet, 1 = normal, 2 = verbose, 3 = debug
log_connections = 1
log_disconnections = 1
log_pooler_errors = 1
log_stats = 1

; Period for writing aggregated stats (seconds)
stats_period = 60

; Logging of queries
; 0 = off, 1 = log all queries
verbose = 0

;;;
;;; Console access
;;;

; Admin console port (for commands like SHOW STATS, SHOW POOLS, etc.)
; Access via: psql -p 6432 -U postgres pgbouncer
admin_users = ${DB_ADMIN_USER}

;;;
;;; Connection sanity checks, timeouts
;;;

; Check server connections are alive before returning them to clients
server_check_query = select 1

; Server connection keepalive settings
server_fast_close = 0

;;;
;;; Performance tuning
;;;

; Use SO_REUSEPORT on listen socket (if supported)
so_reuseport = 1

; TCP socket options
tcp_socket_buffer = 0
tcp_keepalive = 1
tcp_keepcnt = 5
tcp_keepidle = 30
tcp_keepintvl = 10
tcp_user_timeout = 0

; Internal buffer sizes
pkt_buf = 4096
max_packet_size = 2147483647
sbuf_loopcnt = 5

; Interval for checking for DNS updates (seconds)
dns_zone_check_period = 0

; Resume processing connections immediately after suspend
suspend_timeout = 10

;;;
;;; Random stuff
;;;

; Disable idle connections purging (set to 0)
; autodb_idle_timeout = 3600

; Application name to set on connections
application_name_add_host = 1

; Stats tracking
track_extra_parameters = IntervalStyle

;;;
;;; Security
;;;

; Ignore extra parameters received from client
ignore_startup_parameters = extra_float_digits, options

; Allow only specific application names (comma-separated)
; application_name_add_host = 1
